// Prisma schema for PCOS Early-Detection App
// PostgreSQL database with comprehensive health tracking models

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  DOCTOR
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum RiskLevel {
  LOW
  MODERATE
  HIGH
}

enum FlowIntensity {
  LIGHT
  MODERATE
  HEAVY
}

enum ConsentStatus {
  PENDING
  APPROVED
  REVOKED
}

// Core User Model
model User {
  id          String    @id @default(uuid())
  email       String    @unique
  password    String
  role        UserRole  @default(USER)
  firstName   String?
  lastName    String?
  phone       String?
  dateOfBirth DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  doctor               Doctor?
  cycleEntries         CycleEntry[]
  symptomLogs          SymptomLog[]
  riskScores           RiskScore[]
  habitLogs            HabitLog[]
  userChallenges       UserChallenge[]
  appointmentSummaries AppointmentSummary[]
  consentAsPatient  PatientConsent[]    @relation("PatientConsents")
  consentAsDoctor   PatientConsent[]    @relation("DoctorConsents")
  doctorComments    DoctorComment[]
  dailyLogs         DailyLog[]

  // Community relations
  createdCommunities   Community[]          @relation("CommunityCreator")
  communityMemberships CommunityMember[]
  communityPosts       CommunityPost[]
  postReplies          CommunityPostReply[]
  sentMessages         DirectMessage[]      @relation("MessagesSent")
  receivedMessages     DirectMessage[]      @relation("MessagesReceived")
}

// Doctor Profile (extends User)
model Doctor {
  id                  String             @id @default(uuid())
  userId              String             @unique
  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  specialization      String?
  licenseNumber       String?
  verificationStatus  VerificationStatus @default(PENDING)
  yearsOfExperience   Int?
  hospitalAffiliation String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
}

// Menstrual Cycle Tracking
model CycleEntry {
  id            String         @id @default(uuid())
  userId        String
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  startDate     DateTime
  endDate       DateTime?
  flowIntensity FlowIntensity?
  painLevel     Int? // 0-10 scale
  notes         String?
  medications   String[] // Array of medication names
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([userId, startDate])
}

// Symptom Logging (adaptive tracking)
model SymptomLog {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date        DateTime
  symptomType String // e.g., "acne", "hair_loss", "mood_swing", "bloating"
  severity    Int // 0-10 scale
  notes       String?
  createdAt   DateTime @default(now())

  @@index([userId, date])
}

// PCOS Risk Score (explainable AI output)
model RiskScore {
  id           String    @id @default(uuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  score        Float // 0-100
  riskLevel    RiskLevel
  reasons      String[] // Array of explanation strings (e.g., "Cycle >45 days", "BMI trend up")
  calculatedAt DateTime  @default(now())

  // Optional: store input factors for transparency
  cycleLength  Int?
  bmiValue     Float?
  symptomCount Int?

  @@index([userId, calculatedAt])
}

// Habit & Lifestyle Tracking
model HabitLog {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  habitType String // e.g., "walk_10k", "sleep_7h", "no_sugar", "mindful_eating"
  date      DateTime
  completed Boolean  @default(false)
  value     Float? // Optional: actual value (e.g., 8532 steps, 7.5 hours sleep)
  notes     String?
  createdAt DateTime @default(now())

  @@unique([userId, habitType, date])
  @@index([userId, date])
}

// Challenges (gamification)
model Challenge {
  id             String   @id @default(uuid())
  name           String
  description    String
  duration       Int // in days
  habitType      String // links to HabitLog.habitType
  pcosConnection String // Why this helps PCOS
  reward         String? // e.g., "Badge", "Points"
  createdAt      DateTime @default(now())

  userChallenges UserChallenge[]
}

model UserChallenge {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  challengeId   String
  challenge     Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  startDate     DateTime
  endDate       DateTime
  completed     Boolean   @default(false)
  currentStreak Int       @default(0)
  createdAt     DateTime  @default(now())

  @@unique([userId, challengeId, startDate])
  @@index([userId, completed])
}

// Appointment Preparation PDF
model AppointmentSummary {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  generatedAt DateTime @default(now())
  pdfUrl      String? // S3 or local storage path
  data        Json // JSON snapshot of cycle, symptoms, risk data
}

// Patient-Doctor Consent & Access
model PatientConsent {
  id        String        @id @default(uuid())
  patientId String
  patient   User          @relation("PatientConsents", fields: [patientId], references: [id], onDelete: Cascade)
  doctorId  String
  doctor    User          @relation("DoctorConsents", fields: [doctorId], references: [id], onDelete: Cascade)
  status    ConsentStatus @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@unique([patientId, doctorId])
  @@index([doctorId, status])
}

// Doctor Comments on Patient Records
model DoctorComment {
  id        String   @id @default(uuid())
  patientId String
  patient   User     @relation(fields: [patientId], references: [id], onDelete: Cascade)
  comment   String
  createdAt DateTime @default(now())

  @@index([patientId, createdAt])
}

// Daily Health Log (questionnaire responses)
model DailyLog {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date            DateTime @db.Date
  
  // Mood tracking
  mood            String?  // e.g., "happy", "sad", "anxious", "energetic", "tired"
  
  // Period related
  isOnPeriod      Boolean  @default(false)
  flowIntensity   String?  // "light", "moderate", "heavy"
  cramps          Int?     // 0-10 scale
  
  // General health
  energyLevel     Int?     // 1-10 scale
  sleepQuality    Int?     // 1-10 scale
  sleepHours      Float?   // hours of sleep
  stressLevel     Int?     // 1-10 scale
  exerciseMinutes Int?     // minutes of exercise
  
  // Symptoms
  symptoms        String[] // Array of symptoms (e.g., "headache", "bloating", "acne", "hair_fall")
  
  // Photo for tracking physical changes (acne, facial hair)
  photoUrl        String?  // Path or URL to the daily photo
  
  // Photo analysis results (AI/ML processed)
  acneCount       Int?     // Detected number of acne spots
  acneSeverity    Float?   // Severity score 0-10
  facialHairScore Float?   // Facial hair density score 0-10
  skinTexture     Float?   // Skin texture quality 0-10
  analysisDate    DateTime? // When photo was analyzed
  
  // Additional notes
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([userId, date])
  @@index([userId, date])
}

// ========================================
// COMMUNITY & MESSAGING MODELS
// ========================================

model Community {
  id          String   @id @default(cuid())
  name        String
  description String?
  creatorId   String
  creator     User     @relation("CommunityCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members CommunityMember[]
  posts   CommunityPost[]

  @@index([creatorId])
}

model CommunityMember {
  id          String    @id @default(cuid())
  communityId String
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role        String    @default("MEMBER") // ADMIN, MODERATOR, MEMBER
  joinedAt    DateTime  @default(now())

  @@unique([communityId, userId])
  @@index([userId])
}

model CommunityPost {
  id          String    @id @default(cuid())
  communityId String
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  authorId    String
  author      User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  content     String    @db.Text
  isPinned    Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  replies CommunityPostReply[]

  @@index([communityId, createdAt])
  @@index([authorId])
}

model CommunityPostReply {
  id        String        @id @default(cuid())
  postId    String
  post      CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId  String
  author    User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  content   String        @db.Text
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([postId, createdAt])
  @@index([authorId])
}

model DirectMessage {
  id         String   @id @default(cuid())
  senderId   String
  sender     User     @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId String
  receiver   User     @relation("MessagesReceived", fields: [receiverId], references: [id], onDelete: Cascade)
  content    String   @db.Text
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([senderId, receiverId, createdAt])
  @@index([receiverId, isRead])
}
